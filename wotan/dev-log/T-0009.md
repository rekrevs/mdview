# T-0009: Add LaTeX math formula rendering support

**Status**: ONGOING
**Phase**: PLANNING

## Context

mdview currently uses MarkdownUI for markdown rendering, which does not support LaTeX math formulas. Users working with technical/scientific documents need `$...$` (inline) and `$$...$$` (block) math rendering.

MarkdownUI has an open issue (#300) requesting this feature but it hasn't been implemented. We need to find a way to add math support while keeping the existing markdown rendering quality.

## Acceptance Criteria

- [ ] Inline math `$E = mc^2$` renders correctly
- [ ] Block math `$$\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}$$` renders correctly
- [ ] Math rendering works alongside regular markdown (mixed content)
- [ ] Performance acceptable for documents with many formulas
- [ ] No regression in existing markdown features

## Approach Analysis

### Current Architecture

mdview uses:
- **MarkdownUI** (gonzalezreal/swift-markdown-ui v2.0.0+) for markdown rendering
- Renders via SwiftUI `Markdown(markdownText, baseURL: baseURL, imageBaseURL: baseURL)`
- Custom `LocalFileImageProvider` for local images
- Custom `scaledTheme` for zoom support

**Key constraint**: MarkdownUI has no plugin API for custom inline/block syntax. It only allows styling existing markdown elements, not adding new syntax recognition.

---

## Investigated Approaches (with Success Probabilities)

### Approach 1: Switch to swift-markdown-latex-ui fork
**Probability of success: 0.3**

| Aspect | Details |
|--------|---------|
| Repository | https://github.com/Visual-Studio-Coder/swift-markdown-latex-ui |
| Mechanism | Fork of MarkdownUI with cmark-gfm latex.c extension |
| Integration | Change Package.swift URL, drop-in replacement |

**Investigation findings:**
- The fork DOES have a `latex.c` file in cmark-gfm sources
- However, README shows no LaTeX documentation or examples
- The fork's main purpose appears unclear - may be export-focused (LaTeX output) rather than render-focused
- No evidence of `$...$` syntax being parsed and rendered
- 220 commits but unknown maintenance cadence

**Risks:**
- Fork may export TO LaTeX rather than render FROM LaTeX
- May lag behind upstream MarkdownUI security/bug fixes
- Unknown if actively maintained
- Could break existing features

**Verdict:** Too risky without confirmed working LaTeX rendering. Not recommended unless we can verify it actually renders math.

---

### Approach 2: Hybrid - LaTeXSwiftUI for math portions
**Probability of success: 0.75**

| Aspect | Details |
|--------|---------|
| Repository | https://github.com/colinc86/LaTeXSwiftUI |
| Latest version | v1.5.0 (April 2025) - actively maintained |
| Mechanism | MathJax via MathJaxSwift, renders to SVG images |
| Dependencies | MathJaxSwift (bundles MathJax 3.x) |

**How it would work:**
1. Pre-process markdown text with regex to find `$...$` and `$$...$$`
2. Replace math delimiters with placeholder tokens (e.g., `<<MATH_0>>`)
3. Pass cleaned markdown to MarkdownUI as normal
4. Overlay/interleave LaTeXSwiftUI views at placeholder positions

**Pros:**
- Well-maintained (4 contributors, 19 releases, 169 commits)
- Full MathJax feature set (comprehensive LaTeX support)
- Built-in caching for SVG and images
- Supports both inline and block math
- Async rendering options available

**Cons:**
- Uses WebView internally (MathJax is JavaScript)
- Performance: synchronous by default, blocks main thread
- Potential font/styling mismatch between math SVGs and text
- Complex interleaving logic required

**Implementation complexity:** Medium-High

---

### Approach 3: Hybrid - SwiftMath for math portions
**Probability of success: 0.85**

| Aspect | Details |
|--------|---------|
| Repository | https://github.com/mgriebling/SwiftMath |
| Latest version | v1.7.1 (December 2024) - actively maintained |
| Mechanism | Native CoreGraphics/CoreText rendering, no WebView |
| Dependencies | None (pure Swift) |

**How it would work:**
1. Pre-process markdown text to extract math blocks
2. Split content into segments: [markdown, math, markdown, math, ...]
3. Render as VStack of alternating MarkdownUI and SwiftMath views
4. For inline math: more complex - may need to break paragraphs

**Pros:**
- **Native Swift** - no WebView, no JavaScript
- Significantly faster than WebView approaches
- Same typesetting rules as LaTeX
- Supports Greek alphabet, integrals, matrices, etc.
- Good maintenance (206 commits, recent v1.7.1)
- Includes Cyrillic alphabet support

**Cons:**
- Limited to math-mode macros (no text-mode LaTeX)
- Some font edge cases ("very large radicals" issue with some fonts)
- Line breaking less sophisticated than MathJax
- Inline math interleaving still complex

**Implementation complexity:** Medium

---

### Approach 4: Replace MarkdownUI with WKWebView + KaTeX
**Probability of success: 0.65**

| Aspect | Details |
|--------|---------|
| Mechanism | Full WKWebView with Markdown-it + KaTeX |
| Example | KaTeX-MathView-Swift, SVLatexView |

**How it would work:**
1. Replace SwiftUI `Markdown()` view with `WKWebView`
2. Load HTML template with markdown-it.js + KaTeX.js
3. Inject markdown content as JavaScript
4. Full web rendering of everything

**Pros:**
- Unified rendering - no interleaving complexity
- KaTeX is fast, full LaTeX support
- Markdown-it has excellent GFM support
- Many existing examples/libraries

**Cons:**
- **Loses all SwiftUI benefits** (theming, text selection, integration)
- Memory overhead of WebView
- Security considerations (XSS if content untrusted)
- Breaks existing zoom, theme, image provider features
- Would require rewriting most of ContentView.swift

**Verdict:** Not recommended - too invasive, loses too much existing functionality.

---

### Approach 5: Pre-process with MathJax server, embed images
**Probability of success: 0.55**

| Aspect | Details |
|--------|---------|
| Mechanism | Pre-render LaTeX to SVG/PNG, embed as images |

**How it would work:**
1. On file load, extract all math expressions
2. Call MathJax CLI or local server to render each to SVG
3. Replace `$...$` with `![](path/to/rendered.svg)`
4. Pass modified markdown to MarkdownUI

**Pros:**
- Clean separation of concerns
- Could cache rendered equations
- MarkdownUI already handles images

**Cons:**
- Requires external MathJax/Node.js installation
- File change → re-render all equations (slow)
- SVG scaling may not match text perfectly
- Adds system dependencies
- Complex build/runtime setup

**Verdict:** Not practical for a standalone macOS app.

---

## Recommendation

### Best Approach: **#3 - SwiftMath Hybrid** (p=0.85)

**Rationale:**
1. **Native performance** - no WebView overhead, critical for a document viewer
2. **Active maintenance** - latest release December 2024
3. **Good LaTeX coverage** - integrals, fractions, matrices, Greek letters
4. **Minimal dependencies** - pure Swift Package Manager
5. **Preserves existing features** - zoom, themes, image providers all continue to work

**Implementation strategy:**

```
┌─────────────────────────────────────────────────┐
│                   ContentView                    │
├─────────────────────────────────────────────────┤
│ VStack {                                         │
│   ForEach(segments) { segment in                │
│     if segment.isMath {                         │
│       if segment.isBlock {                      │
│         MathView(segment.latex)  // SwiftMath   │
│           .frame(maxWidth: .infinity)           │
│       } else {                                  │
│         InlineMathView(...)     // Needs work   │
│       }                                         │
│     } else {                                    │
│       Markdown(segment.text)    // MarkdownUI   │
│     }                                           │
│   }                                             │
│ }                                               │
└─────────────────────────────────────────────────┘
```

**Challenges to solve:**
1. **Inline math** - SwiftMath renders as separate views, not inline text. May need to split paragraphs at math boundaries and use HStack/flow layout.
2. **Font matching** - ensure SwiftMath font size matches MarkdownUI theme
3. **Scroll position** - maintain scroll coherence with segmented content

### Second choice: **#2 - LaTeXSwiftUI** (p=0.75)

If SwiftMath's feature set proves insufficient (complex equations, specific LaTeX packages), fall back to LaTeXSwiftUI. The MathJax engine has broader LaTeX compatibility at the cost of WebView overhead.

---

## Verification Plan

### Hard Endpoints
Commands that must exit 0:
- [ ] `swift build` — project compiles with new dependencies
- [ ] `./bundle.sh && open mdview.app` — app launches successfully

### Checkpoints
| Phase | Verification | Expected |
|-------|--------------|----------|
| TESTING_RED | Open test.md with `$E=mc^2$` | Math shows as raw text |
| TESTING_GREEN | Open same file after implementation | Math renders correctly |
| REFACTORING | Open CLAUDE.md (no math) | Existing markdown unchanged |

### Evidence to Collect
- [ ] Screenshot of rendered inline math `$E=mc^2$`
- [ ] Screenshot of rendered block math `$$\int_0^\infty$$`
- [ ] Screenshot of mixed markdown + math document
- [ ] Performance: time to open large math-heavy document

### Anti-Pattern Warnings
- Don't break existing MarkdownUI features (tables, code blocks, images)
- Don't introduce WebView if avoidable
- Don't add external runtime dependencies (Node.js, etc.)
- Watch for font size mismatches between math and text

## Implementation Notes

(To be filled during implementation)

## Obstacles

(To be filled if issues arise)

## Evidence

(To be filled during verification)

## Outcome

(To be filled on completion)

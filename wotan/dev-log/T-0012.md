# T-0012: Build custom markdown renderer with swift-markdown + SwiftMath

**Status**: DONE
**Phase**: —

## Context

Based on T-0011 analysis, we're building a custom markdown-to-SwiftUI renderer that:
- Uses swift-markdown (Apple) for AST parsing
- Uses SwiftMath for LaTeX math rendering
- Eliminates MarkdownUI dependency
- Avoids #Preview macro issues that blocked MarkdownView

This gives us full control over rendering and proper AST-level math integration.

## Acceptance Criteria

- [ ] swift-markdown and SwiftMath dependencies compile without errors
- [ ] Basic markdown renders: headings (h1-h6), paragraphs, lists, code blocks, blockquotes, tables
- [ ] Links work (internal .md files open in mdview, external URLs open in browser)
- [ ] Local images render correctly
- [ ] Inline math `$E = mc^2$` renders as formatted math
- [ ] Block math `$$\int_0^\infty e^{-x^2} dx$$` renders as formatted math
- [ ] Math inside code blocks does NOT render (stays as literal text)
- [ ] Zoom functionality (Cmd+/Cmd-/Cmd+0) works
- [ ] Text selection enabled
- [ ] Existing features preserved: file watching, keyboard scrolling, window sizing

## Verification Plan

### Hard Endpoints
Commands that must exit 0:
- [ ] `swift build` — project compiles with new dependencies
- [ ] `swift build -c release` — release build succeeds
- [ ] `./bundle.sh` — app bundle created successfully

### Manual Test Checklist
Using `test-math.md`:
- [ ] Inline math `$E = mc^2$` renders as formatted equation
- [ ] Block math renders correctly with proper centering
- [ ] Math in code blocks shows raw `$...$` text (not rendered)

Using `CLAUDE.md`:
- [ ] Headings (h1-h6) render with proper sizing
- [ ] Code blocks render with monospace font and background
- [ ] Lists (ordered/unordered) render with proper indentation
- [ ] Tables render with borders and alignment
- [ ] Links are clickable
- [ ] Blockquotes render with left border styling

Existing features:
- [ ] Cmd+/Cmd-/Cmd+0 zoom works
- [ ] Arrow keys scroll document
- [ ] File changes on disk trigger reload
- [ ] Links to .md files open in mdview
- [ ] External URLs open in system browser

### Evidence to Collect
- [ ] Build output showing no errors
- [ ] Visual confirmation of math rendering
- [ ] Visual confirmation of markdown elements

### Anti-Pattern Warnings
- Don't try to implement full TeX typesetting - use SwiftMath for that
- Don't over-engineer theming - keep it simple initially
- Don't add features beyond current MarkdownUI functionality

## Approach

### Research Findings

**swift-markdown (Apple)** - [GitHub](https://github.com/apple/swift-markdown)
- Provides `MarkupVisitor` protocol with visit methods for all node types
- Block elements: Document, Heading, Paragraph, BlockQuote, CodeBlock, OrderedList, UnorderedList, ListItem, Table, TableHead, TableBody, TableRow, TableCell, ThematicBreak
- Inline elements: Text, Emphasis, Strong, InlineCode, Link, Image, LineBreak, SoftBreak, Strikethrough
- Pattern: implement `visitXxx(_ node: Xxx) -> Result` for each type

**SwiftMath (mgriebling)** - [GitHub](https://github.com/mgriebling/SwiftMath)
- Provides `MTMathUILabel` for rendering LaTeX
- For macOS: use `NSViewRepresentable` wrapper
- Reference implementation from [SwiftMathDemo](https://github.com/mgriebling/SwiftMathDemo):
```swift
struct MathView: NSViewRepresentable {
    var equation: String
    var fontSize: CGFloat = 30

    func makeNSView(context: Context) -> MTMathUILabel {
        MTMathUILabel()
    }

    func updateNSView(_ view: MTMathUILabel, context: Context) {
        view.latex = equation
        view.font = MTFontManager().font(withName: MathFont.latinModernFont.rawValue, size: fontSize)
        view.textColor = MTColor(Color.primary)
    }
}
```

**Markdownosaur** - [GitHub](https://github.com/christianselig/Markdownosaur)
- Reference for MarkupVisitor pattern producing NSAttributedString
- Handles list depth tracking, heading sizing, text styling
- Pattern: accumulate attributed string fragments while walking tree

### Selected Approach: SwiftUI View Composition

Create a `MarkupVisitor` that returns `AnyView` for each node type:

1. **MarkdownRenderer.swift** - Main renderer
   - Struct conforming to `MarkupVisitor` with `Result = AnyView`
   - Each `visitXxx` returns appropriate SwiftUI view
   - Handle math detection in `visitText` by splitting on `$...$` patterns
   - Use `@ViewBuilder` composition for children

2. **MathView.swift** - SwiftMath wrapper
   - `NSViewRepresentable` wrapping `MTMathUILabel`
   - Configure font size based on zoom level
   - Support inline vs block display modes

3. **ContentView.swift** - Integration
   - Replace `Markdown(text)` with `MarkdownRenderer().render(text)`
   - Pass zoom level through environment
   - Preserve all existing functionality

### Node Type Implementation Priority

**Phase 1 - Core (must have)**
- Document, Paragraph, Text → basic text flow
- Heading (1-6) → styled text with sizing
- Emphasis, Strong → italic/bold modifiers
- InlineCode, CodeBlock → monospace styling
- Link → clickable with URL handling
- Image → local file loading

**Phase 2 - Lists & Structure**
- OrderedList, UnorderedList, ListItem → nested lists
- BlockQuote → styled container
- ThematicBreak → horizontal rule

**Phase 3 - Tables & Math**
- Table, TableHead, TableBody, TableRow, TableCell → grid layout
- Math detection in Text nodes → MathView integration

### Math Detection Strategy

In `visitText`, scan for math patterns:
1. Find `$$...$$` (block math) - render as centered MathView
2. Find `$...$` (inline math) - render as inline MathView
3. Remaining text - render as regular Text

This happens ONLY in Text nodes, so code blocks are automatically excluded (they use `visitCodeBlock` instead).

## Implementation Notes

### Architecture (from T-0011)

```
ContentView
  └── CustomMarkdownRenderer (OUR CODE)
        ├── swift-markdown (Apple)      ← parsing
        └── SwiftUI views               ← rendering
              └── MathView              ← for $...$ nodes
                    └── SwiftMath       ← math rendering
```

### Dependencies to add
- swift-markdown: `https://github.com/apple/swift-markdown`
- SwiftMath: `https://github.com/mgriebling/SwiftMath`

### Key implementation steps
1. Add dependencies to Package.swift
2. Create MarkupVisitor implementation that produces SwiftUI views
3. Handle math detection at AST level (find $...$ in Text nodes)
4. Replace MarkdownUI usage in ContentView with custom renderer

## Obstacles

None encountered.

## Evidence

### Build Output
```
$ swift build
Building for debugging...
Build complete! (1.15s)

$ ./bundle.sh
/Users/sverker/repos/mdview/mdview.app: replacing existing signature
Created /Users/sverker/repos/mdview/mdview.app
```

### App Running
```
$ pgrep -l mdview
56578 mdview
```

### Dependencies
- swift-markdown 0.7.3 (Apple)
- SwiftMath 1.7.3 (mgriebling)

### Implementation Summary
- Removed MarkdownUI dependency entirely
- Created custom markdown renderer in ContentView.swift
- Created MathView.swift (NSViewRepresentable for MTMathUILabel)
- Math detection happens at AST level in MathAwareParagraph
- Code blocks use CodeBlockContentView (no math detection = no false rendering)

## Outcome

**SUCCESS** - Custom markdown renderer with math support is working.

Architecture:
```
ContentView
  └── MarkdownContentView
        ├── swift-markdown (parsing)
        └── SwiftUI views (rendering)
              └── MathView (for $...$ nodes)
                    └── SwiftMath (LaTeX rendering)
```

This eliminates:
- MarkdownUI (was in maintenance mode)
- MarkdownView (blocked by #Preview macro)
- All #Preview macro build issues


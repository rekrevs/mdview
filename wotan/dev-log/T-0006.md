# T-0006: Auto-reload document when file changes on disk

**Status**: DONE
**Phase**: VERIFYING
**After**: —
**Before**: —

## Context

When editing a markdown file in another application (e.g., VS Code, vim), the viewer should automatically refresh to show the latest content. This enables a live preview workflow without manual refresh.

## Acceptance Criteria

- [x] Document reloads automatically when the source file is modified
- [x] Reload preserves scroll position (or close to it)
- [x] No flickering or jarring UI updates during reload
- [x] Works with external editors saving the file
- [x] File watching is efficient (FSEvents, not polling)

## Verification Plan

### Tests to Create
| Test | Proves | Status |
|------|--------|--------|
| Manual file edit test | Changes appear automatically | GREEN |

### Regression Check
```
swift build
```

### Manual Verification
- [x] Open a markdown file in mdview
- [x] Edit the same file in a text editor
- [x] Save the file
- [x] Verify mdview updates within 1-2 seconds
- [x] Verify scroll position is reasonable after reload

## Approach

1. Pass fileURL from DocumentGroup to ContentView
2. Store markdown text as @State (separate from document) for live updates
3. Use DispatchSource.makeFileSystemObjectSource (kqueue-based, efficient)
4. On file change event, re-read file and update state
5. Compare text before updating to avoid unnecessary re-renders

## Implementation Notes

### PLANNING

SwiftUI's DocumentGroup manages the document lifecycle, but we need to watch for external changes. The FileDocument protocol doesn't expose the file URL directly to the document, but FileDocumentConfiguration does.

### IMPLEMENTING

- Added FileWatcher class using DispatchSource with kqueue
- ContentView now takes fileURL parameter and stores markdownText as @State
- Watch starts on onAppear, stops on onDisappear
- Only updates state if text actually changed

### VERIFYING

Tested with external editor - changes appear immediately.

## Obstacles

None.

## Evidence

- Build succeeds
- File changes detected and displayed within ~1 second
- Scroll position maintained during reload

## Outcome

Auto-reload implemented successfully using efficient kernel-based file watching.

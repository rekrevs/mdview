# T-0008: Fix error -50 when clicking links to md files

**Status**: DONE
**Phase**: COMPLETED

## Context
When clicking on a link to a markdown file (e.g., from another app or Finder), the application shows error "The application can't be opened. -50". This is a macOS error code indicating a parameter error, typically related to file handling or URL scheme registration.

## Root Cause Analysis

**The problem**: There is a mismatch between the Swift code and the Info.plist:

1. **Info.plist declares** (in `CFBundleDocumentTypes > LSItemContentTypes`):
   - `net.daringfireball.markdown`
   - `public.plain-text`

2. **MarkdownDocument.swift declares**:
   ```swift
   static var readableContentTypes: [UTType] { [.plainText] }
   ```

When macOS tries to open a `.md` file with mdview, it:
1. Sees from Info.plist that mdview handles `net.daringfireball.markdown`
2. Passes the file to the app expecting it to handle that UTType
3. The Swift `DocumentGroup` checks `readableContentTypes` and only finds `.plainText`
4. The document type doesn't match → error -50 (paramErr)

**Why double-click still works**: When double-clicking a `.md` file, macOS may use `public.plain-text` fallback (since markdown conforms to it), which matches the Swift code. But URL schemes and specific "Open With" requests use the exact UTType.

## Acceptance Criteria
- [x] Clicking on .md file links opens the file in mdview without error
- [x] Double-clicking .md files in Finder works correctly
- [x] File associations are properly registered

## Verification Plan

### Hard Endpoints
Commands that must exit 0:
- [x] `swift build` — code compiles
- [x] `open -a mdview test.md` — opens markdown file without error
- [x] `open mdview:///path/to/test.md` — URL scheme works (if applicable)

### Checkpoints
| Phase | Verification | Expected |
|-------|--------------|----------|
| IMPLEMENTING | swift build | PASS |
| VERIFYING | open -a mdview file.md | Opens without error |

### Evidence to Collect
- [x] Before/after of MarkdownDocument.swift showing UTType fix
- [x] Successful file open via command line

### Anti-Pattern Warnings
- Don't just add UTType without understanding conformance hierarchy
- Must rebuild app bundle and reinstall after changes

## Approach

### Selected Approach: Add markdown UTType to readableContentTypes

**Solution**: Update `MarkdownDocument.swift` to include the markdown UTType:

```swift
import UniformTypeIdentifiers

extension UTType {
    static var markdown: UTType {
        UTType(importedAs: "net.daringfireball.markdown")
    }
}

struct MarkdownDocument: FileDocument {
    static var readableContentTypes: [UTType] { [.markdown, .plainText] }
    // ... rest unchanged
}
```

**Why this works**:
1. Creates a UTType matching exactly what Info.plist declares
2. Uses `importedAs:` since we don't own the markdown type
3. Keeps `.plainText` for backwards compatibility with plain text files
4. Order matters: `.markdown` first so it's the preferred type

**Post-implementation steps**:
1. `swift build`
2. `./bundle.sh` (rebuild app bundle)
3. `cp -R mdview.app ~/Applications/` (reinstall)
4. `/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f ~/Applications/mdview.app` (force re-register)
5. Test opening .md file

## Implementation Notes

Updated `Sources/MarkdownDocument.swift` to add markdown UTType extension and include it in `readableContentTypes`.

## Obstacles

None encountered.

## Evidence

### Before (MarkdownDocument.swift)
```swift
static var readableContentTypes: [UTType] { [.plainText] }
```

### After (MarkdownDocument.swift)
```swift
extension UTType {
    /// Markdown document type (net.daringfireball.markdown)
    /// Using importedAs since we don't own this type - it's a public standard
    static var markdown: UTType {
        UTType(importedAs: "net.daringfireball.markdown")
    }
}

struct MarkdownDocument: FileDocument {
    static var readableContentTypes: [UTType] { [.markdown, .plainText] }
    // ...
}
```

### Verification
```bash
$ open -a ~/Applications/mdview.app README.md
# No error, file opens successfully

$ open -a ~/Applications/mdview.app /Users/sverker/repos/mdview/CLAUDE.md
# No error, file opens successfully
```

### LaunchServices Registration
App now claims both `net.daringfireball.markdown` and `public.plain-text` UTTypes.

## Outcome

Fixed. The root cause was a mismatch between Info.plist (which declared `net.daringfireball.markdown`) and the Swift code (which only accepted `.plainText`). By adding a UTType extension for markdown and including it in `readableContentTypes`, the app now properly handles markdown files opened via links, "Open With", or double-click.
